<!DOCTYPE html>
<html xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common :: common-head(
            pageTitle='Product',
            pageSpecificCss=~{:: .page-css}
          )}"></head>
<th:block class="page-css">
    <link rel="stylesheet" href="/assets/css/dashboard/product/list.css">
</th:block>
<body>
<style>
    .action-btn {
        border-radius: 10px !important;
        padding: 6px 18px !important;
        font-size: 0.9rem !important;
        font-weight: 600;
        white-space: nowrap;
        display: inline-block;
    }

    /* Colors */
    .btn-details {
        border: 1px solid #d0d5dd !important;
        color: #344054 !important;
    }

    .btn-edit {
        border: 1px solid #feca57 !important;
        color: #d48700 !important;
    }

    .btn-delete {
        border: 1px solid #ff6b6b !important;
        color: #d62828 !important;
    }
</style>
<div th:replace="~{fragments/common :: navbar-main}"></div>

<!-- Main Content -->
<div class="container my-5">

    <div class="card p-4 mb-4">
        <div class="row g-3">
            <!-- Title -->
            <div class="col-12 col-md-4">
                <h2 class="fw-bold mb-0">Product List</h2>
            </div>

            <!-- Actions -->
            <div class="col-12 col-md-8 d-flex justify-content-md-end gap-2">
                <a th:href="@{/product/deleted-list}" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-trash me-1"></i> Trash
                </a>
                <a th:href="@{/product/create}" class="btn btn-outline-primary">
                    <i class="fa-solid fa-plus me-1"></i> Create New Product
                </a>
            </div>
            <!-- Search Bar -->
            <div class="col-12 mt-3">
                <form th:action="@{/product/search}" method="get" class="d-flex">
                    <input type="text"
                           name="keyword"
                           class="form-control me-2"
                           placeholder="Enter product name to search..."
                           th:value="${keyword}" aria-label="Search">
                    <button class="btn btn-brand-primary text-nowrap" type="submit">
                        <i class="fa-solid fa-search me-1"></i> Search
                    </button>
                </form>
            </div>

        </div>
    </div>

    <!-- Main content row (Filter + Table) -->
    <div class="row g-4">

        <!-- Column 1: Filter -->
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Filter by Category</h5>
                </div>
                <div class="card-body p-4">
                    <form th:action="@{/product/list}" method="get">
                        <input type="hidden" name="keyword" th:value="${keyword}"/>

                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="categoryId" id="category-all" value="0"
                                   th:checked="${selectedCategoryId == null || selectedCategoryId == 0}"
                                   onchange="this.form.submit()">
                            <label class="form-check-label" for="category-all">
                                -- All Categories --
                            </label>
                        </div>

                        <div th:each="category : ${categoryList}" class="form-check">
                            <input class="form-check-input" type="radio" name="categoryId"
                                   th:id="'category-' + ${category.cateId}"
                                   th:value="${category.cateId}"
                                   th:checked="${category.cateId == selectedCategoryId}"
                                   onchange="this.form.submit()">
                            <label class="form-check-label"
                                   th:for="'category-' + ${category.cateId}"
                                   th:text="${category.cateName}">
                                Category Name
                            </label>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Column 2: Product Table -->
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="card-body p-0">

                    <!-- Empty State -->
                    <div th:if="${pageProduct.isEmpty()}" class="p-4 text-center">
                        <i class="fa-solid fa-box-open fa-3x text-muted mb-3"></i>
                        <h4 class="mb-0">No Products Found</h4>
                        <p class="text-muted">There are no products matching your criteria.</p>
                    </div>

                    <!-- Product Table -->
                    <div th:unless="${pageProduct.isEmpty()}" class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                            <tr>
                                <th scope="col" class="ps-4">#</th>
                                <th scope="col">Image</th>
                                <th scope="col">Product Name</th>
                                <th scope="col">Price</th>
                                <th scope="col">Category</th>
                                <th scope="col">Status</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Active</th>
                                <th scope="col" class="pe-4">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="product, i : ${pageProduct}" th:object="${product}">
                                <td class="ps-4"
                                    th:text="${(pageProduct.number * pageProduct.size) + i.index + 1}"></td>

                                <td class="text-center">
                                    <img th:src="@{/uploads/{img}(img=*{img})}"
                                         alt="Product Image"
                                         class="product-photo"
                                         th:onerror="|this.src='https://placehold.co/60x60/f4f7f6/6c757d?text=No+Img'|"/>
                                </td>

                                <td th:text="*{proName}">Product Name</td>

                                <td th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + ' VND'}"
                                    class="text-end text-danger fw-bold text-nowrap">100,000 VND
                                </td>

                                <td th:text="*{category.cateName}">Category Name</td>

                                <td>
                                        <span th:if="*{status.equalsIgnoreCase('available')}"
                                              class="badge text-bg-success">Available</span>
                                    <span th:if="*{status.equalsIgnoreCase('unavailable')}"
                                          class="badge text-bg-danger">Unavailable</span>
                                </td>

                                <td th:text="*{quantity}">
                                </td>
                                <td>
                                    <span th:if="*{active}" class="badge text-bg-success">Yes</span>
                                    <span th:unless="*{active}" class="badge text-bg-secondary">No</span>
                                </td>

                                <td class="pe-4">
                                    <div class="d-flex gap-2">

                                        <a class="btn action-btn btn-details"
                                           th:href="@{/product/{id}(id=*{proId})}">
                                            Details
                                        </a>

                                        <a class="btn action-btn btn-edit"
                                           th:href="@{/product/edit/{id}(id=*{proId})}">
                                            Edit
                                        </a>

                                        <button class="btn action-btn btn-delete"
                                                th:data-id="*{proId}"
                                                th:data-name="*{proName}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModal"
                                                sec:authorize="hasAnyRole('ROLE_ADMIN')">
                                            Delete
                                        </button>

                                    </div>
                                </td>

                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination (if not empty) -->
                <div class="card-footer d-flex justify-content-center" th:if="${pageProduct.getTotalPages() > 1}">
                    <nav aria-label="Product Page Navigation">
                        <ul class="pagination mb-0">
                            <th:block th:with="
                                currentPage=${pageProduct.getNumber() + 1},
                                totalPages=${pageProduct.getTotalPages()},
                                currentURL='/product/list',
                                keywordParam=${keyword},
                                categoryIdParam=${selectedCategoryId}
                            ">
                                <li class="page-item" th:classappend="${pageProduct.isFirst()} ? 'disabled' : ''">
                                    <a class="page-link"
                                       th:href="@{${currentURL}(
                                       page=${currentPage - 1},
                                       keyword=${keywordParam},
                                       categoryId=${categoryIdParam}
                                   )}">Previous</a>
                                </li>

                                <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                                    th:classappend="${i == currentPage} ? 'active':''">
                                    <a class="page-link"
                                       th:href="@{${currentURL}(
                                       page=${i},
                                       keyword=${keywordParam},
                                       categoryId=${categoryIdParam}
                                   )}"
                                       th:text="${i}"></a>
                                </li>

                                <li class="page-item" th:classappend="${pageProduct.isLast()} ? 'disabled'">
                                    <a class="page-link"
                                       th:href="@{${currentURL}(
                                       page=${currentPage + 1},
                                       keyword=${keywordParam},
                                       categoryId=${categoryIdParam}
                                   )}">Next</a>
                                </li>
                            </th:block>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:insert="~{layout/footer}"></div>
<!-- Modal Xác nhận Xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 0.75rem;">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product?</p>
                <p class="mb-0"><strong>Product:</strong> <span id="modalProductName"></span></p>
                <p class="text-warning mt-2"><i class="fa-solid fa-triangle-exclamation me-1"></i> This action may
                    affect related orders.</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" name="_method" value="delete"/> <!-- Use this if Spring Boot expects DELETE -->
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<!-- Custom JS for Delete Modal -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');

                const modalProductName = deleteModal.querySelector('#modalProductName');
                const deleteForm = deleteModal.querySelector('#deleteForm');

                modalProductName.textContent = name;

                // Set the form action dynamically
                deleteForm.action = `/product/delete/${id}`;
            });
        }
    });
</script>

</body>
</html>
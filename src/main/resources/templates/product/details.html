<!DOCTYPE html>
<html xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common :: common-head(
            pageTitle='Product',
            pageSpecificCss=~{:: .page-css}
          )}"></head>
<th:block class="page-css">
    <link rel="stylesheet" href="/assets/css/dashboard/product/detail.css">
</th:block>
<body>
<div th:replace="~{fragments/common :: navbar-main}"></div>

<!-- Main Content -->
<div class="container my-5">

    <!-- Not Found Message -->
    <div th:if="${product == null}" class="card p-5 text-center">
        <i class="fa-solid fa-mug-saucer fa-3x text-muted mb-3"></i>
        <h2 class="fw-bold">Product Not Found!</h2>
        <p class="text-muted">Sorry, the product you are looking for does not exist or has been deleted.</p>
        <div class="mt-3">
            <a th:href="@{/home}" class="btn btn-brand-primary">Back to Home</a>
        </div>
    </div>

    <!-- Product Details -->
    <div th:if="${product != null}">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">

                <!-- NEW: Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="fw-bold mb-0" th:text="${product.getProName()}">PRODUCT NAME HERE</h1>
                    <!--                    <a th:href="@{/menu}" class="btn btn-outline-secondary" sec:authorize="hasAnyRole('ROLE_CUSTOMER')">-->
                    <!--                        <i class="fa-solid fa-arrow-left me-1"></i> Back to Menu-->
                    <!--                    </a>-->
                    <!--                    <a th:href="@{/product/list}" class="btn btn-outline-secondary"-->
                    <!--                       sec:authorize="hasAnyRole('ROLE_ADMIN')">-->
                    <!--                        <i class="fa-solid fa-arrow-left me-1"></i> Back to Menu-->
                    <!--                    </a>-->
                </div>

                <!-- UPDATED: Product Info Card -->
                <div class="card mb-4">
                    <div class="card-body p-4 p-md-5">
                        <!-- Product Info Row -->
                        <div class="row g-4 g-md-5">
                            <!-- Image Column -->
                            <div class="col-md-5 d-flex flex-column align-items-center">
                                <img th:src="@{/uploads/{img}(img=${product.getImg()})}"
                                     th:onerror="|this.src='https://placehold.co/400x400/f4f7f6/6c757d?text=No+Img'|"
                                     alt="Product Image"
                                     class="img-fluid mb-3 product-image"
                                />
                            </div>

                            <!-- Details Column -->
                            <div class="col-md-7">

                                <div class="mb-4">
                                    <span class="detail-label">Price</span><br>
                                    <span class="price-text"
                                          th:text="${#numbers.formatDecimal(product.getPrice(), 0, 'COMMA', 0, 'POINT')}">55,000</span>
                                    <span class="price-text-currency">VND</span>
                                </div>

                                <hr class="my-4">

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <span class="detail-label">Category</span>
                                        <p class="fs-6 mt-1 mb-0" th:text="${product.getCategory().getCateName()}">
                                            Category
                                            Name</p>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <span class="detail-label">Status</span>
                                        <p class="mt-1 mb-0">
                                        <span th:if="${product.getStatus().equalsIgnoreCase('available')}"
                                              class="badge status-available fs-6 px-3 py-2">Available</span>
                                            <span th:if="${product.getStatus().equalsIgnoreCase('unavailable')}"
                                                  class="badge status-unavailable fs-6 px-3 py-2">Unavailable</span>
                                        </p>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <span class="detail-label">Quantity</span>

                                        <span
                                              th:text="${product.quantity}"></span>
                                    </div>


                                    <a class="btn btn-sm btn-outline-primary"
                                       sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_BARISTA')"
                                       th:href="@{/product/edit/{id}(id=${product.proId})}">
                                        Edit
                                    </a>

                                </div>

                                <hr class="my-4">

                                <div class="mt-4">
                                    <span class="detail-label">Description</span>
                                    <p class="text-secondary fs-6 mt-1" style="line-height: 1.6;"
                                       th:text="${product.getDescription()}">
                                        Product description placeholder...
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Product Info Card -->

                <!-- NEW: Feedback Card -->
                <div class="card">
                    <div class="card-body p-4 p-md-5">

                        <!-- Feedback Section -->
                        <h3 class="fw-bold">Feedback</h3>
                        <div th:if="${errorMessage}" class="alert alert-danger p-2" role="alert">
                            <p class="mb-0" th:text="${errorMessage}"></p>
                        </div>

                        <!-- Feedback Form -->
                        <div th:if="${isBought}">
                            <form th:action="@{/product/{id}(id=${product.proId})}" method="post" class="mb-4">
                                <div class="mb-3">
                                    <label for="comment" class="form-label fw-bold">Leave your feedback:</label>
                                    <textarea id="comment" name="content" class="form-control" rows="3" required
                                              placeholder="Enter your comment..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-brand-primary">Send Feedback</button>
                            </form>
                        </div>
                        <div th:if="${!isBought}">
                            <div class="alert alert-info mt-3" role="alert">
                                <i class="fa-solid fa-circle-info me-1"></i>
                                You haven’t purchased this product, so you can’t leave feedback.
                            </div>
                        </div>

                        <!-- Feedback List -->
                        <div th:if="${feedbackList.isEmpty()}" class="mt-4">
                            <p class="text-muted fst-italic">There are no comments for this product yet.</p>
                        </div>

                        <div th:if="${!feedbackList.isEmpty()}" class="mt-4">
                            <div class="list-group">
                                <div class="list-group-item mb-3 border-0 feedback-card p-3"
                                     th:each="c : ${feedbackList}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <!-- Name and date -->
                                        <div>
                                            <strong class="text-dark" th:text="${c.customer.name}"></strong>
                                            <small class="text-muted ms-2"
                                                   th:text="${#temporals.format(c.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
                                        </div>

                                        <!-- Buttons -->
                                        <div th:if="${customerId == c.customer.cusId}" class="btn-group">
                                            <button type="button" class="btn btn-sm btn-brand-primary"
                                                    data-bs-toggle="modal"
                                                    th:data-bs-target="'#editModal-' + ${c.feedbackId}">
                                                Edit
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    th:data-bs-target="'#deleteModal-' + ${c.feedbackId}">
                                                Delete
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Comment Content -->
                                    <p class="mt-2 mb-0 ps-1" th:text="${c.content}"></p>

                                    <!-- Edit Modal -->
                                    <div class="modal fade" th:id="'editModal-' + ${c.feedbackId}" tabindex="-1"
                                         aria-labelledby="editModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <form th:action="@{/product/{productId}/feedback/{feedbackId}/edit(productId=${product.proId}, feedbackId=${c.feedbackId})}"
                                                      method="post">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="editModalLabel">Edit Feedback</h5>
                                                        <button type="button" class="btn-close"
                                                                data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div th:if="${errorMessage}" class="alert alert-danger mx-3 p-2"
                                                         role="alert">
                                                        <p class="mb-0" th:text="${errorMessage}"></p>
                                                    </div>
                                                    <div class="modal-body">
                                                        <textarea class="form-control" name="content" rows="4"
                                                                  th:text="${c.content}" required></textarea>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-outline-secondary"
                                                                data-bs-dismiss="modal">Cancel
                                                        </button>
                                                        <button type="submit" class="btn btn-brand-primary">Save
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Delete Modal -->
                                    <div class="modal fade" th:id="'deleteModal-' + ${c.feedbackId}" tabindex="-1"
                                         aria-labelledby="deleteModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <form th:action="@{/product/{productId}/feedback/{feedbackId}/delete(productId=${product.proId}, feedbackId=${c.feedbackId})}"
                                                      method="post">
                                                    <div class="modal-header bg-danger text-white">
                                                        <h5 class="modal-title" id="deleteModalLabel">Delete
                                                            Feedback</h5>
                                                        <button type="button" class="btn-close btn-close-white"
                                                                data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>Are you sure you want to delete this feedback?</p>
                                                        <p class="text-muted fst-italic" th:text="${c.content}"></p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-outline-secondary"
                                                                data-bs-dismiss="modal">Cancel
                                                        </button>
                                                        <button type="submit" class="btn btn-danger">Delete</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Feedback Card -->

            </div>
        </div>
    </div>
</div>
<div th:insert="~{layout/footer}"></div>
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

</body>
</html>
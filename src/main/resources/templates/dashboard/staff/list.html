<html>
<head th:replace="~{fragments/common :: common-head(
            pageTitle='Staffs',
            pageSpecificCss=~{:: .page-css}
          )}"></head>
<th:block class="page-css">
    <link rel="stylesheet" href="/assets/css/dashboard/staff/list.css">
</th:block>
<body>
<div th:replace="~{fragments/common :: navbar-main}"></div>
<!-- Main Content -->
<div class="container my-5">

    <!-- Header Card: Title, Search, and Actions -->
    <div class="card p-4 mb-4">
        <div class="row g-3">
            <!-- Title -->
            <div class="col-12 col-md-4">
                <h2 class="fw-bold mb-0">Staff List</h2>
            </div>

            <!-- Actions -->
            <div class="col-12 col-md-8 d-flex justify-content-md-end gap-2">
                <a th:href="@{/dashboard/staff/deleted}" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-trash me-1"></i> Trash
                </a>
                <a th:href="@{/dashboard/staff/new}" class="btn btn-outline-primary">
                    <i class="fa-solid fa-plus me-1"></i> Add New Staff
                </a>
            </div>

            <!-- Search Bar -->
            <div class="col-12 mt-3">
                <form class="d-flex" role="search" th:action="@{/dashboard/staff}" method="get">
                    <input class="form-control me-2" type="search" name="keyword"
                           placeholder="Search by name, email or role..." th:value="${keyword}" aria-label="Search">
                    <button class="btn btn-outline-secondary" type="submit" style="white-space: nowrap;">Search</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Staff Table -->
    <div th:if="${notFound}" class="alert alert-warning" th:text="${notFound}">
    </div>

    <div th:if="${staffs != null}">
        <div class="card shadow-sm overflow-hidden"> <!-- overflow-hidden for rounded corners on table -->
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table  table-hover align-middle">
                        <thead>
                        <tr>
                            <th class="p-3 text-center">Photo</th>
                            <th class="p-3">ID</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Email</th>
                            <th class="p-3">Phone</th>
                            <th class="p-3">Role</th>
                            <th class="p-3">Is Active</th>
                            <th class="p-3 text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="staff : ${staffs}">
                        <tr th:if="${staff.active}" th:each="staff, iterStat : ${staffs}" th:object="${staff}">
                            <td class="p-3 text-center">
                                <img th:src="${staff.img != null ? staff.img : 'https://placehold.co/60x60/f4f7f6/6c757d?text=No+Img'}"
                                     th:onerror="|this.src='https://placehold.co/60x60/f4f7f6/6c757d?text=No+Img'|"
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem;">

                            <td class="p-3" th:text="${iterStat.count}" scope="row"></td>
                            <td class="p-3" th:text="${staff.name}">Nguyen Van A</td>
                            <td class="p-3" th:text="${staff.email}">abc@gmail.com</td>
                            <td class="p-3" th:text="${staff.phoneNumber}">0123456789</td>
                            <td class="p-3" th:text="${staff.role != null ? staff.role.roleName : 'Unknown'}"></td>
                            <td class="p-3">
                                <span th:text="${staff.isActive ? 'Active' : 'Not Active'}"
                                      th:classappend="${staff.isActive ? 'text-success' : 'text-danger'}"
                                      class="fw-bold"></span>
                            </td>
                            <td class="p-3 text-center" style="white-space: nowrap;">
                                <a th:href="@{/dashboard/staff/{id}(id=${staff.managerId})}"
                                   class="btn btn-sm btn-outline-secondary">Details</a>
                                <a th:href="@{/dashboard/staff/edit/{id}(id=${staff.managerId})}"
                                   class="btn btn-sm btn-outline-warning text-dark">Edit</a>
                                <button class="btn btn-sm btn-outline-danger btn-delete"
                                        th:data-id="${staff.managerId}"
                                        th:data-name="${staff.name}"
                                        th:data-email="${staff.email}"
                                        th:data-phoneNumber="${staff.phoneNumber}"
                                        th:data-role="${staff.role.roleName}">
                                    Delete
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination (if not empty) -->
            <div class_="card-footer bg-white" th:if="${totalPages > 0}">
                <nav aria-label="Page navigation" class="d-flex justify-content-center pt-3">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/dashboard/staff(page=${currentPage - 1}, keyword=${keyword})}"
                               aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link"
                               th:href="@{/dashboard/staff(page=${i}, keyword=${keyword})}" th:text="${i}"></a>
                        </li>
                        <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/dashboard/staff(page=${currentPage + 1}, keyword=${keyword})}"
                               aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

        </div> <!-- .card -->
    </div> <!-- th:if staffs -->

</div> <!-- .container -->
<div th:insert="~{layout/footer}"></div>

<!-- Modal Xác nhận Xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this staff?</p>
                <ul class="list-unstyled">
                    <li><strong>Name:</strong> <span id="modalName"></span></li>
                    <li><strong>Email:</strong> <span id="modalEmail"></span></li>
                    <li><strong>Phone Number:</strong> <span id="modalPhoneNumber"></span></li>
                    <li><strong>Role:</strong> <span id="modalRole"></span></li>
                </ul>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post" style="display:inline;">
                    <!-- Add CSRF token to form if available -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type.button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<!-- JavaScript xử lý Delete -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deleteButtons = document.querySelectorAll(".btn-delete");

        deleteButtons.forEach(btn => {
            btn.addEventListener("click", function () {
                const id = this.getAttribute("data-id");
                const name = this.getAttribute("data-name");
                const email = this.getAttribute("data-email");
                const phoneNumber = this.getAttribute("data-phoneNumber");
                const role = this.getAttribute("data-role");

                document.getElementById("modalName").textContent = name;
                document.getElementById("modalEmail").textContent = email;
                document.getElementById("modalPhoneNumber").textContent = phoneNumber;
                document.getElementById("modalRole").textContent = role;

                // GÁN action vào form
                document.getElementById("deleteForm").action = `/dashboard/staff/delete/${id}`;

                const modal = new bootstrap.Modal(document.getElementById("deleteModal"));
                modal.show();
            });
        });
    });
</script>

</body>
</html>